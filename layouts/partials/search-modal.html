<div id="search-modal" class="search-modal" style="display: none;">
    <div class="modal-backdrop" id="modal-backdrop"></div>
    <div class="modal-container">
        <div class="modal-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-secondary);">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <input type="text" id="modal-search-input" placeholder="搜索文章..." autocomplete="off">
            <button id="close-modal" class="close-btn">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                </svg>
            </button>
        </div>
        <div id="modal-search-results" class="modal-results"></div>
        <div class="keyboard-hint">
            <span><kbd>↑↓</kbd> 导航</span>
            <span><kbd>Enter</kbd> 打开</span>
            <span><kbd>Esc</kbd> 关闭</span>
        </div>
    </div>
</div>

<style>
.search-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 15vh;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
}

.modal-container {
    position: relative;
    width: 90%;
    max-width: 640px;
    max-height: 70vh;
    background: var(--bg-primary);
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.modal-header {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    gap: 0.75rem;
}

#modal-search-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 1.125rem;
    color: var(--text-primary);
    outline: none;
    font-family: var(--bodyFont);
}

#modal-search-input::placeholder {
    color: var(--text-muted);
}

.close-btn {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s;
}

.close-btn:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.modal-results {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

.search-result-item {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 0.25rem;
}

.search-result-item:hover,
.search-result-item.selected {
    background: var(--bg-secondary);
}

.search-result-item h3 {
    font-size: 1rem;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
}

.search-result-item h3 a {
    color: inherit;
    text-decoration: none;
}

.excerpt {
    font-size: 0.875rem;
    color: var(--text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.keyboard-hint {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.75rem;
    color: var(--text-muted);
    display: flex;
    gap: 1rem;
    pointer-events: none;
}

.keyboard-hint kbd {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.125rem 0.5rem;
    font-family: var(--codeFont);
    font-size: 0.75rem;
}
</style>

<script>
(function() {
    const modal = document.getElementById('search-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const input = document.getElementById('modal-search-input');
    const results = document.getElementById('modal-search-results');
    const closeBtn = document.getElementById('close-modal');
    let fuse;
    let selectedIndex = 0;

    // Load search index
    fetch('/index.json')
        .then(response => response.json())
        .then(data => {
            fuse = new Fuse(data, {
                keys: ['title', 'content', 'tags'],
                threshold: 0.3,
                includeScore: true,
                minMatchCharLength: 1
            });
        })
        .catch(error => console.error('Error loading search index:', error));

    // Cmd/Ctrl + K to open
    document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            openModal();
        }
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
        }
    });

    function openModal() {
        modal.style.display = 'flex';
        input.focus();
        input.value = '';
        results.innerHTML = '';
        selectedIndex = 0;
    }

    function closeModal() {
        modal.style.display = 'none';
    }

    closeBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);

    // Search input
    input.addEventListener('input', (e) => {
        const query = e.target.value.trim();
        selectedIndex = 0;

        if (query.length < 1) {
            results.innerHTML = '';
            return;
        }

        if (!fuse) {
            results.innerHTML = '<div class="search-result-item">加载中...</div>';
            return;
        }

        const searchResults = fuse.search(query);

        if (searchResults.length === 0) {
            results.innerHTML = '<div class="search-result-item">没有找到结果</div>';
            return;
        }

        results.innerHTML = searchResults.slice(0, 8).map((result, index) => {
            const item = result.item;
            return `
                <div class="search-result-item ${index === 0 ? 'selected' : ''}" data-index="${index}" data-url="${item.url}">
                    <h3><a href="${item.url}">${item.title}</a></h3>
                    <p class="excerpt">${getExcerpt(item.content, query)}</p>
                </div>
            `;
        }).join('');

        results.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', () => {
                window.location.href = item.dataset.url;
            });
        });
    });

    // Keyboard navigation
    input.addEventListener('keydown', (e) => {
        const items = results.querySelectorAll('.search-result-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            updateSelection(items);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            updateSelection(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            const selected = items[selectedIndex];
            if (selected) {
                window.location.href = selected.dataset.url;
            }
        }
    });

    function updateSelection(items) {
        items.forEach((item, index) => {
            item.classList.toggle('selected', index === selectedIndex);
        });
    }

    function getExcerpt(content, query) {
        const index = content.toLowerCase().indexOf(query.toLowerCase());
        if (index === -1) return content.substring(0, 150) + '...';

        const start = Math.max(0, index - 50);
        const end = Math.min(content.length, index + query.length + 100);
        return (start > 0 ? '...' : '') + content.substring(start, end) + '...';
    }
})();
</script>