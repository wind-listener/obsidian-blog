{{ define "title" }}搜索 - {{ .Site.Title }}{{ end }}

{{ define "main" }}
<div class="search-page">
    <h1>搜索</h1>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="输入关键词搜索..." autocomplete="off">
        <div id="search-results"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
<script>
    const searchInput = document.getElementById('search-input');
    const searchResults = document.getElementById('search-results');
    let fuse;

    // 加载搜索索引
    fetch('/index.json')
        .then(response => response.json())
        .then(data => {
            const options = {
                keys: ['title', 'content', 'tags'],
                threshold: 0.3,
                includeScore: true,
                minMatchCharLength: 2
            };
            fuse = new Fuse(data, options);
        })
        .catch(error => console.error('Error loading search index:', error));

    // 搜索功能
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();

        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }

        if (!fuse) {
            searchResults.innerHTML = '<p class="no-results">搜索索引加载中...</p>';
            return;
        }

        const results = fuse.search(query);

        if (results.length === 0) {
            searchResults.innerHTML = '<p class="no-results">没有找到相关结果</p>';
            return;
        }

        const html = results.slice(0, 10).map(result => {
            const item = result.item;
            const excerpt = getExcerpt(item.content, query);
            const tags = item.tags ? item.tags.map(tag => `<span class="tag">#${tag}</span>`).join(' ') : '';

            return `
                <div class="search-result-item">
                    <h3><a href="${item.url}">${item.title}</a></h3>
                    <p class="excerpt">${excerpt}</p>
                    ${tags ? `<div class="tags">${tags}</div>` : ''}
                </div>
            `;
        }).join('');

        searchResults.innerHTML = html;
    });

    function getExcerpt(content, query) {
        const lowerContent = content.toLowerCase();
        const lowerQuery = query.toLowerCase();
        const index = lowerContent.indexOf(lowerQuery);

        if (index === -1) {
            return content.substring(0, 200) + '...';
        }

        const start = Math.max(0, index - 60);
        const end = Math.min(content.length, index + query.length + 140);
        const excerpt = content.substring(start, end);

        return (start > 0 ? '...' : '') + excerpt + (end < content.length ? '...' : '');
    }
</script>

<style>
    .search-page h1 {
        font-size: 2.5rem;
        margin-bottom: 2rem;
        color: var(--text-primary);
    }

    .search-container {
        max-width: 700px;
    }

    #search-input {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: border-color 0.2s;
    }

    #search-input:focus {
        outline: none;
        border-color: var(--link-color);
    }

    #search-results {
        margin-top: 2rem;
    }

    .search-result-item {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid var(--border-color);
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-item h3 {
        font-size: 1.4rem;
        margin-bottom: 0.5rem;
    }

    .search-result-item h3 a {
        text-decoration: none;
        color: var(--text-primary);
        transition: color 0.2s;
    }

    .search-result-item h3 a:hover {
        color: var(--link-color);
    }

    .excerpt {
        color: var(--text-secondary);
        line-height: 1.6;
        margin-bottom: 0.5rem;
    }

    .no-results {
        color: var(--text-secondary);
        font-style: italic;
        text-align: center;
        padding: 2rem;
    }

    .tags {
        margin-top: 0.5rem;
    }

    .tag {
        background-color: var(--bg-secondary);
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-right: 0.5rem;
        color: var(--link-color);
    }
</style>
{{ end }}
